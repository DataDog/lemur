# JWT Token Generation and API Usage

## Yes! JWT tokens can be generated via API

Lemur provides a login endpoint that returns a JWT token for authentication.

## Method 1: Generate JWT via API Login (Recommended)

### Login to Get JWT Token

```bash
# Login with username/password to receive JWT token
curl -k -X POST "https://localhost:8447/api/1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user",
    "password": "pass"
  }'
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3Njg5NTM3NDUsImV4cCI6MTc2OTA0MDE0NSwic3ViIjoyfQ.5R4S3YGxTd_jOyiDwERPthRHeKxzpiyvd2dim1o2ug8"
}
```

### Use JWT Token for API Calls

```bash
# Extract token from login response
JWT_TOKEN=$(curl -k -s -X POST "https://localhost:8447/api/1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "user", "password": "pass"}' | \
  python3 -c "import sys, json; print(json.load(sys.stdin)['token'])")

# Use the token to create a destination
curl -k -X POST "https://localhost:8447/api/1/destinations" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "label": "my-destination",
    "description": "Created with JWT from API",
    "plugin": {"slug": "aws-destination"},
    "options": {
      "accountNumber": "123456789012"
    }
  }'
```

## Method 2: Generate JWT via Helper Script (Development)

### Generate Token with Script

```bash
docker exec -i local-lemur python3 /opt/lemur/local/jwt_auth_helper.py generate \
  --user-id 1 \
  --email "user@email.com" \
  --roles "admin" \
  --hours 24 \
  --verbose
```

**Output:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3Njg5NTM2MTAsImV4cCI6MTc2OTA0MDAxMCwic3ViIjoxLCJlbWFpbCI6InVzZXJAZW1haWwuY29tIiwiaXNzIjoibGVtdXIiLCJhdWQiOiJsZW11ci1sb2NhbC1kZXYiLCJyb2xlcyI6WyJhZG1pbiJdfQ.uzqaDKLym35HZVpUntF2EbN4_Is_fH4zTGOFbGoSZs4

üîê Generated JWT Token
============================================================
{
  "iat": 1768953610,
  "exp": 1769040010,
  "sub": 1,
  "email": "user@email.com",
  "iss": "lemur",
  "aud": "lemur-local-dev",
  "roles": [
    "admin"
  ]
}
```

### Use Generated Token

```bash
JWT_TOKEN="eyJhbG..."  # Token from above

curl -k -X POST "https://localhost:8447/api/1/destinations" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "label": "my-destination",
    "plugin": {"slug": "aws-destination"},
    "options": {"accountNumber": "123456789012"}
  }'
```

## Method 3: Use Pre-Generated Constant Token (Testing)

For integration tests, use the constant token that's valid until 2027:

```bash
export JWT_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3Njg1MjE2MDAsImV4cCI6MTgwMDA1NzYwMCwic3ViIjoxfQ.sKrQgiwoLzijuEUZEPmf-waTEHfFtDBfYTBwynStWHI"

curl -k -H "Authorization: Bearer $JWT_TOKEN" \
  "https://localhost:8447/api/1/destinations"
```

## Complete Example Script

```bash
#!/bin/bash
# Complete workflow: Login, get JWT, create destination

BASE_URL="https://localhost:8447/api/1"

echo "1. Login to get JWT token"
LOGIN_RESPONSE=$(curl -k -s -X POST "$BASE_URL/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "user", "password": "pass"}')

JWT_TOKEN=$(echo "$LOGIN_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['token'])")
echo "‚úì JWT Token: ${JWT_TOKEN:0:50}..."

echo ""
echo "2. Create destination using JWT"
curl -k -X POST "$BASE_URL/destinations" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "label": "created_with_jwt_from_api",
    "description": "Destination created using JWT from API login",
    "plugin": {"slug": "aws-destination"},
    "options": {"accountNumber": "123456789012"}
  }' | python3 -m json.tool

echo ""
echo "3. Verify destination was created"
curl -k -s -H "Authorization: Bearer $JWT_TOKEN" \
  "$BASE_URL/destinations" | \
  python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"Total destinations: {data['total']}\")"

echo ""
echo "‚úÖ Complete!"
```

## JWT Token Structure

All JWT tokens generated by Lemur include:

```json
{
  "iat": 1768953745,        // Issued at (timestamp)
  "exp": 1769040145,        // Expiration (timestamp)
  "sub": 1,                 // Subject (user ID)
  "email": "user@email.com", // Optional: user email
  "iss": "lemur",           // Issuer
  "aud": "lemur-local-dev", // Audience
  "roles": ["admin"]        // Optional: user roles
}
```

## Token Expiration

- API-generated tokens: Default 24 hours (configurable via `JWT_EXPIRATION_DELTA`)
- Script-generated tokens: Customizable (use `--hours` parameter)
- Constant test token: Valid until 2027

## Comparison

| Method | Use Case | Pros | Cons |
|--------|----------|------|------|
| **API Login** | Production, Integration Tests | Standard, secure, works everywhere | Requires valid user credentials |
| **Helper Script** | Local development, testing | Flexible, custom claims, long expiration | Requires container access |
| **Constant Token** | CI/CD, automated tests | No login needed, long-lived | Fixed user ID, less flexible |

## Related Documentation

- [SERVICE_AUTHENTICATION.md](SERVICE_AUTHENTICATION.md) - Authentication patterns for tools/services
- [INTEGRATION_TEST_CONNECTION.md](INTEGRATION_TEST_CONNECTION.md) - Connection details and examples
- [VAULT_JWT_INTEGRATION.md](VAULT_JWT_INTEGRATION.md) - JWT configuration and Vault integration
- [API_CERT_WITH_DESTINATIONS.md](API_CERT_WITH_DESTINATIONS.md) - Creating certificates via API
